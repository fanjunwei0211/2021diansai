#include "converse.h"
#include "pid.h"
#include <math.h>
#define pi 3.141592653f


DUTY duty_cycle;  //Õ¼¿Õ±È
				
CLARKE clarke;
PARK park;
ICLARKE iclarke;
IPARK ipark;
SVGENDQ SV_dq;

float iq,id;
//float sin_[361]={0.000000,0.017452,0.034899,0.052336,0.069756,0.087156,0.104528,0.121869,0.139173,0.156434,0.173648,0.190809,0.207912,0.224951,0.241922,0.258819,0.275637,0.292372,0.309017,0.325568,0.342020,0.358368,0.374607,0.390731,0.406737,0.422618,0.438371,0.453991,0.469472,0.484810,0.500000,0.515038,0.529919,0.544639,0.559193,0.573576,0.587785,0.601815,0.615661,0.629320,0.642788,0.656059,0.669131,0.681998,0.694658,0.707107,0.719340,0.731354,0.743145,0.754710,0.766044,0.777146,0.788011,0.798636,0.809017,0.819152,0.829038,0.838671,0.848048,0.857167,0.866025,0.874620,0.882948,0.891007,0.898794,0.906308,0.913545,0.920505,0.927184,0.933580,0.939693,0.945519,0.951057,0.956305,0.961262,0.965926,0.970296,0.974370,0.978148,0.981627,0.984808,0.987688,0.990268,0.992546,0.994522,0.996195,0.997564,0.998630,0.999391,0.999848,1.000000,0.999848,0.999391,0.998630,0.997564,0.996195,0.994522,0.992546,0.990268,0.987688,0.984808,0.981627,0.978148,0.974370,0.970296,0.965926,0.961262,0.956305,0.951057,0.945519,0.939693,0.933580,0.927184,0.920505,0.913545,0.906308,0.898794,0.891006,0.882948,0.874620,0.866025,0.857167,0.848048,0.838671,0.829037,0.819152,0.809017,0.798635,0.788011,0.777146,0.766044,0.754710,0.743145,0.731354,0.719340,0.707107,0.694658,0.681998,0.669131,0.656059,0.642787,0.629320,0.615661,0.601815,0.587785,0.573576,0.559193,0.544639,0.529919,0.515038,0.500000,0.484810,0.469472,0.453990,0.438371,0.422618,0.406737,0.390731,0.374606,0.358368,0.342020,0.325568,0.309017,0.292372,0.275637,0.258819,0.241922,0.224951,0.207912,0.190809,0.173648,0.156434,0.139173,0.121869,0.104528,0.087156,0.069756,0.052336,0.034899,0.017452,-0.000000,-0.017453,-0.034900,-0.052336,-0.069756,-0.087156,-0.104528,-0.121869,-0.139173,-0.156435,-0.173648,-0.190809,-0.207912,-0.224951,-0.241922,-0.258819,-0.275638,-0.292372,-0.309017,-0.325568,-0.342020,-0.358368,-0.374607,-0.390731,-0.406737,-0.422618,-0.438371,-0.453991,-0.469472,-0.484810,-0.500000,-0.515038,-0.529919,-0.544639,-0.559193,-0.573577,-0.587785,-0.601815,-0.615661,-0.629320,-0.642788,-0.656059,-0.669131,-0.681998,-0.694659,-0.707107,-0.719340,-0.731354,-0.743145,-0.754710,-0.766045,-0.777146,-0.788011,-0.798635,-0.809017,-0.819152,-0.829038,-0.838671,-0.848048,-0.857167,-0.866025,-0.874620,-0.882948,-0.891007,-0.898794,-0.906308,-0.913545,-0.920505,-0.927184,-0.933580,-0.939693,-0.945519,-0.951057,-0.956305,-0.961262,-0.965926,-0.970296,-0.974370,-0.978148,-0.981627,-0.984808,-0.987688,-0.990268,-0.992546,-0.994522,-0.996195,-0.997564,-0.998630,-0.999391,-0.999848,-1.000000,-0.999848,-0.999391,-0.998630,-0.997564,-0.996195,-0.994522,-0.992546,-0.990268,-0.987688,-0.984808,-0.981627,-0.978148,-0.974370,-0.970296,-0.965926,-0.961262,-0.956305,-0.951056,-0.945519,-0.939693,-0.933580,-0.927184,-0.920505,-0.913545,-0.906308,-0.898794,-0.891006,-0.882948,-0.874620,-0.866025,-0.857167,-0.848048,-0.838671,-0.829038,-0.819152,-0.809017,-0.798635,-0.788011,-0.777146,-0.766045,-0.754709,-0.743145,-0.731354,-0.719340,-0.707107,-0.694658,-0.681998,-0.669131,-0.656059,-0.642787,-0.629320,-0.615661,-0.601815,-0.587785,-0.573576,-0.559193,-0.544639,-0.529919,-0.515038,-0.500000,-0.484809,-0.469471,-0.453991,-0.438371,-0.422618,-0.406736,-0.390731,-0.374606,-0.358368,-0.342020,-0.325568,-0.309017,-0.292372,-0.275638,-0.258819,-0.241922,-0.224951,-0.207911,-0.190809,-0.173648,-0.156434,-0.139173,-0.121869,-0.104529,-0.087156,-0.069756,-0.052336,-0.034900,-0.017452,0.000000};
//float cos_[361]={1.000000,0.999848,0.999391,0.998630,0.997564,0.996195,0.994522,0.992546,0.990268,0.987688,0.984808,0.981627,0.978148,0.974370,0.970296,0.965926,0.961262,0.956305,0.951057,0.945519,0.939693,0.933580,0.927184,0.920505,0.913545,0.906308,0.898794,0.891007,0.882948,0.874620,0.866025,0.857167,0.848048,0.838671,0.829038,0.819152,0.809017,0.798635,0.788011,0.777146,0.766044,0.754710,0.743145,0.731354,0.719340,0.707107,0.694658,0.681998,0.669131,0.656059,0.642788,0.629320,0.615661,0.601815,0.587785,0.573576,0.559193,0.544639,0.529919,0.515038,0.500000,0.484810,0.469472,0.453990,0.438371,0.422618,0.406737,0.390731,0.374607,0.358368,0.342020,0.325568,0.309017,0.292372,0.275637,0.258819,0.241922,0.224951,0.207912,0.190809,0.173648,0.156434,0.139173,0.121869,0.104528,0.087156,0.069757,0.052336,0.034899,0.017452,-0.000000,-0.017452,-0.034899,-0.052336,-0.069757,-0.087156,-0.104529,-0.121869,-0.139173,-0.156434,-0.173648,-0.190809,-0.207912,-0.224951,-0.241922,-0.258819,-0.275637,-0.292372,-0.309017,-0.325568,-0.342020,-0.358368,-0.374607,-0.390731,-0.406737,-0.422618,-0.438371,-0.453991,-0.469472,-0.484810,-0.500000,-0.515038,-0.529919,-0.544639,-0.559193,-0.573576,-0.587785,-0.601815,-0.615661,-0.629320,-0.642788,-0.656059,-0.669131,-0.681999,-0.694658,-0.707107,-0.719340,-0.731354,-0.743145,-0.754710,-0.766045,-0.777146,-0.788011,-0.798636,-0.809017,-0.819152,-0.829038,-0.838671,-0.848048,-0.857167,-0.866025,-0.874620,-0.882948,-0.891007,-0.898794,-0.906308,-0.913545,-0.920505,-0.927184,-0.933580,-0.939693,-0.945519,-0.951057,-0.956305,-0.961262,-0.965926,-0.970296,-0.974370,-0.978148,-0.981627,-0.984808,-0.987688,-0.990268,-0.992546,-0.994522,-0.996195,-0.997564,-0.998630,-0.999391,-0.999848,-1.000000,-0.999848,-0.999391,-0.998630,-0.997564,-0.996195,-0.994522,-0.992546,-0.990268,-0.987688,-0.984808,-0.981627,-0.978148,-0.974370,-0.970296,-0.965926,-0.961262,-0.956305,-0.951057,-0.945519,-0.939693,-0.933580,-0.927184,-0.920505,-0.913545,-0.906308,-0.898794,-0.891007,-0.882948,-0.874620,-0.866025,-0.857167,-0.848048,-0.838671,-0.829038,-0.819152,-0.809017,-0.798635,-0.788011,-0.777146,-0.766044,-0.754710,-0.743145,-0.731354,-0.719340,-0.707107,-0.694658,-0.681998,-0.669131,-0.656059,-0.642787,-0.629320,-0.615662,-0.601815,-0.587785,-0.573576,-0.559193,-0.544639,-0.529919,-0.515038,-0.500000,-0.484810,-0.469472,-0.453990,-0.438371,-0.422618,-0.406737,-0.390731,-0.374606,-0.358368,-0.342020,-0.325568,-0.309017,-0.292372,-0.275637,-0.258819,-0.241922,-0.224951,-0.207911,-0.190809,-0.173648,-0.156435,-0.139173,-0.121869,-0.104528,-0.087156,-0.069756,-0.052336,-0.034899,-0.017452,0.000000,0.017453,0.034900,0.052336,0.069757,0.087156,0.104528,0.121870,0.139173,0.156435,0.173649,0.190809,0.207912,0.224951,0.241922,0.258819,0.275638,0.292372,0.309017,0.325568,0.342020,0.358368,0.374607,0.390731,0.406737,0.422618,0.438371,0.453991,0.469472,0.484810,0.500000,0.515038,0.529919,0.544639,0.559193,0.573577,0.587785,0.601815,0.615662,0.629320,0.642788,0.656059,0.669131,0.681998,0.694659,0.707107,0.719340,0.731354,0.743145,0.754710,0.766045,0.777146,0.788011,0.798636,0.809017,0.819152,0.829037,0.838671,0.848048,0.857167,0.866026,0.874620,0.882948,0.891007,0.898794,0.906308,0.913546,0.920505,0.927184,0.933581,0.939693,0.945519,0.951057,0.956305,0.961262,0.965926,0.970296,0.974370,0.978148,0.981627,0.984808,0.987688,0.990268,0.992546,0.994522,0.996195,0.997564,0.998630,0.999391,0.999848,1.000000};
//float tan_[361]={0.000000,0.017455,0.034921,0.052408,0.069927,0.087489,0.105104,0.122785,0.140541,0.158384,0.176327,0.194380,0.212557,0.230868,0.249328,0.267949,0.286745,0.305731,0.324920,0.344328,0.363970,0.383864,0.404026,0.424475,0.445229,0.466308,0.487733,0.509525,0.531709,0.554309,0.577350,0.600861,0.624869,0.649408,0.674509,0.700208,0.726543,0.753554,0.781286,0.809784,0.839100,0.869287,0.900404,0.932515,0.965689,1.000000,1.035530,1.072369,1.110613,1.150369,1.191754,1.234897,1.279942,1.327045,1.376382,1.428148,1.482561,1.539865,1.600334,1.664280,1.732051,1.804048,1.880727,1.962611,2.050304,2.144507,2.246037,2.355853,2.475087,2.605089,2.747478,2.904211,3.077684,3.270853,3.487415,3.732052,4.010781,4.331476,4.704631,5.144556,5.671284,6.313751,7.115370,8.144348,9.514368,11.430045,14.300659,19.081174,28.636354,57.290038,-22877332.428856,-57.289751,-28.636282,-19.081142,-14.300641,-11.430033,-9.514360,-8.144342,-7.115365,-6.313752,-5.671282,-5.144553,-4.704626,-4.331474,-4.010779,-3.732049,-3.487414,-3.270852,-3.077683,-2.904211,-2.747478,-2.605088,-2.475086,-2.355852,-2.246036,-2.144506,-2.050304,-1.962610,-1.880726,-1.804047,-1.732051,-1.664280,-1.600334,-1.539865,-1.482561,-1.428148,-1.376381,-1.327045,-1.279942,-1.234897,-1.191754,-1.150369,-1.110612,-1.072368,-1.035530,-1.000000,-0.965688,-0.932515,-0.900404,-0.869287,-0.839099,-0.809784,-0.781286,-0.753554,-0.726542,-0.700208,-0.674508,-0.649407,-0.624869,-0.600861,-0.577350,-0.554309,-0.531709,-0.509525,-0.487733,-0.466308,-0.445229,-0.424475,-0.404026,-0.383864,-0.363970,-0.344328,-0.324920,-0.305731,-0.286745,-0.267949,-0.249328,-0.230868,-0.212556,-0.194380,-0.176327,-0.158384,-0.140541,-0.122784,-0.105104,-0.087489,-0.069927,-0.052408,-0.034921,-0.017455,0.000000,0.017455,0.034921,0.052408,0.069927,0.087489,0.105104,0.122785,0.140541,0.158385,0.176327,0.194380,0.212557,0.230868,0.249328,0.267949,0.286746,0.305731,0.324920,0.344328,0.363970,0.383864,0.404026,0.424475,0.445229,0.466308,0.487733,0.509526,0.531710,0.554309,0.577351,0.600861,0.624869,0.649407,0.674509,0.700208,0.726543,0.753554,0.781285,0.809784,0.839100,0.869287,0.900404,0.932515,0.965689,1.000000,1.035530,1.072369,1.110613,1.150369,1.191754,1.234897,1.279942,1.327044,1.376383,1.428148,1.482561,1.539866,1.600336,1.664278,1.732051,1.804048,1.880726,1.962612,2.050305,2.144507,2.246037,2.355852,2.475089,2.605090,2.747478,2.904211,3.077687,3.270850,3.487417,3.732052,4.010780,4.331483,4.704636,5.144558,5.671283,6.313749,7.115362,8.144362,9.514376,11.430056,14.300750,19.081075,28.636425,57.290325,-83858283.006684,-57.288682,-28.636014,-19.081067,-14.300647,-11.430053,-9.514374,-8.144328,-7.115361,-6.313748,-5.671267,-5.144557,-4.704624,-4.331473,-4.010780,-3.732044,-3.487410,-3.270850,-3.077682,-2.904210,-2.747478,-2.605087,-2.475085,-2.355852,-2.246034,-2.144507,-2.050302,-1.962610,-1.880726,-1.804048,-1.732049,-1.664280,-1.600334,-1.539865,-1.482561,-1.428147,-1.376381,-1.327044,-1.279941,-1.234897,-1.191754,-1.150368,-1.110612,-1.072369,-1.035529,-1.000000,-0.965688,-0.932515,-0.900404,-0.869286,-0.839099,-0.809784,-0.781285,-0.753554,-0.726543,-0.700207,-0.674509,-0.649407,-0.624869,-0.600861,-0.577350,-0.554309,-0.531709,-0.509525,-0.487732,-0.466307,-0.445228,-0.424474,-0.404026,-0.383864,-0.363970,-0.344327,-0.324920,-0.305731,-0.286746,-0.267949,-0.249328,-0.230868,-0.212556,-0.194380,-0.176327,-0.158384,-0.140540,-0.122785,-0.105104,-0.087489,-0.069927,-0.052408,-0.034921,-0.017455,0.000000};

int ToDegree(float rad)
{
   return (rad*180.0/pi);
}  


/*atan²é±í*****************************************************************/

#define M_2PI (2 * 3.1415926535897932384626433832795)
#define M_PI 3.1415926535897932384626433832795
#define M_PI_2 (3.1415926535897932384626433832795 / 2)
#define	LUT_NUM		450	/*¸ÃÖµÔ½´ó±í¾«¶ÈÔ½¸ß,¾«¶ÈÎªatan(1/LUT_NUM)*/

#define Rad_Precision 573

u16 g_atan_tab[LUT_NUM];

#define	ASIN_NUM		450
u16 g_asin_tab[ASIN_NUM];

void atan2_tab_init(void)  
{
	u16 i = 0;

	for (i = 0; i < LUT_NUM; i++)
	{
		g_atan_tab[i] = (u16)(atan((float)i / (LUT_NUM - 1)) * Rad_Precision);
	}
}

/**
* @brief	atan2²é±í·¨
* @param[in] y
* @param[in] x
* @note µ÷ÓÃ´Ëº¯ÊýÖ®Ç°ÐèÏÈµ÷ÓÃatan2_tab_init()Éú³É±í
* @see
* @code
* @retval	·µ»Ø»¡¶ÈÖµ
*/
float atan2_tab_calc(float y, float x)
{
	float Y_X, Y_X_temp;
	float result = 0;

	Y_X = (x == 0) ? (float)x / y : (float)y / x;
	Y_X_temp = Y_X;

	if (y == 0)
	{
		if (x >= 0)
			return 0;
		else
			return (M_PI);  //Return Pi
	}
	else if (x > 0 && y > 0)
	{
		//µÚÒ»ÏóÏÞ
		Y_X = (Y_X <= 1) ? Y_X  : 1 / Y_X;
		result = (Y_X_temp > 1)? M_PI_2 - (float)g_atan_tab[(int16_t)(Y_X*(LUT_NUM - 1))] / Rad_Precision : (float)g_atan_tab[(int16_t)(Y_X*(LUT_NUM - 1))] / Rad_Precision;
	}
	else if (x < 0 && y > 0)
	{
		//µÚ¶þÏóÏÞ
		Y_X = (Y_X < -1)? Y_X = -1 / Y_X : -Y_X;
		result = (Y_X_temp >= -1) ? M_PI - (float)g_atan_tab[(int16_t)(Y_X*(LUT_NUM - 1))] / Rad_Precision : //Ð¡ÓÚ45¡ã
								M_PI_2 + (float)g_atan_tab[(int16_t)(Y_X*(LUT_NUM - 1))] / Rad_Precision;
	}
	else if (x < 0 && y < 0)
	{
		//µÚÈýÏóÏÞ
		Y_X = (Y_X <= 1) ? Y_X : 1 / Y_X;
		result = (Y_X_temp <= 1) ? (float)g_atan_tab[(int16_t)(Y_X*(LUT_NUM - 1))] / Rad_Precision - M_PI: -M_PI_2 - (float)g_atan_tab[(int16_t)(Y_X*(LUT_NUM - 1))] / Rad_Precision;
	}
	else if(x > 0 && y < 0)
	{
		//µÚËÄÏóÏÞ
		Y_X = (Y_X < -1) ? Y_X = -1 / Y_X : -Y_X;
		result = (Y_X_temp >= -1) ? -(float)g_atan_tab[(int16_t)(Y_X*(LUT_NUM - 1))] / Rad_Precision : //Ð¡ÓÚ45¡ã
								-(M_PI_2 - (float)g_atan_tab[(int16_t)(Y_X*(LUT_NUM - 1))] / Rad_Precision);
	}
	else if(x == 0 && y > 0)
	{
		result = M_PI_2;
	}
	else
	{
		result = -M_PI_2;
	}

	return result;
}
/************************************************************************************************** 
 Function				: clarke_calc;
 Description			: Clark transform;
						  a,b,c -> alpha,beta
 Call by				: functions in TBC;
 Input Variables		: CLARKE
 Output/Return Variables: CL   ARKE
 Subroutine Call		: NONE
 Reference				: NONE
**************************************************************************************************/
void clarke_calc(CLARKE *v)
{	
//   v->ds = v->as;
   v->ds = 0.666666667 * (v->as-(0.5 * v->bs)-(0.5 * v->cs));

   v->qs = (v->bs - v->cs) * (0.57735026918963);
   
}

/************************************************************************************************** 
 Function				: park_calc;
 Description			: Park transform;
						  alpha,beta -> d,q
 Call by				: functions in TBC;
 Input Variables		: PARK
 Output/Return Variables: PARK
 Subroutine Call		: NONE
 Reference				: NONE
**************************************************************************************************/
void park_calc(PARK *v)
{	
  
    float cos_ang,sin_ang;

    /* Using look-up IQ sine table */
     sin_ang = sin_[ToDegree(v->ang)];
     cos_ang = cos_[ToDegree(v->ang)];

	 	
     v->de = (v->ds * cos_ang) + (v->qs * sin_ang);
     v->qe = (v->qs * cos_ang) - (v->ds * sin_ang);
     
}

/************************************************************************************************** 
 Function				: iclarke_calc;
 Description			: Inv Clark transform;
						  alpha,beta -> a,b,c
 Call by				: functions in TBC;
 Input Variables		: ICLARKE
 Output/Return Variables: ICLARKE
 Subroutine Call		: NONE
 Reference				: NONE
**************************************************************************************************/
void iclarke_calc(ICLARKE *v)
{	

     v->as = v->ds;
     v->bs = ((-0.5) * v->ds) + ((0.86602540) * v->qs);
     v->cs = ((-0.5) * v->ds) - ((0.86602540) * v->qs);
    
}

/************************************************************************************************** 
 Function				: ipark_calc;
 Description			: Inv Park transform;
						  d,q -> alpha,beta 
 Call by				: functions in TBC;
 Input Variables		: IPARK
 Output/Return Variables: IPARK
 Subroutine Call		: NONE
 Reference				: NONE
**************************************************************************************************/
void ipark_calc(IPARK *v)
{	
   
   float cos_ang,sin_ang;
   
/* Using look-up IQ sine table */  
     sin_ang = sin_[ToDegree(v->ang)];
     cos_ang = cos_[ToDegree(v->ang)];
 
     v->ds = (v->de * cos_ang) - (v->qe * sin_ang);
     v->qs = (v->qe * cos_ang) + (v->de * sin_ang);
}

///**************************************************************************************************
// Function				: svgendq_calc;
// Description			: SV pwm generation;
// Call by				: functions in TBC;
// Input Variables		: Valpha,Vbeta,Vdc
// Output/Return Variables: a,b,c PWM ratio
// Subroutine Call		: NONE
// Reference				: NONE
//**************************************************************************************************/
//void svgendq_calc(SVGENDQ *v)
//{

//	float Va,Vb,Vc,t1,t2,a,b;
//	u32 Sector = 0;  // Sector is treated as Q0 - independently with global Q
///*	long Sector3[2][2] = {{_IQ(1.5),_IQ(-0.8660)},{_IQ(0),_IQ(1.7321)}};
//	long Sector1[2][2] = {{_IQ(-1.5),_IQ(0.8660)},{_IQ(1.5),_IQ(0.8660)}};
//	long Sector5[2][2] = {{_IQ(0),_IQ(1.7321)},{_IQ(-1.5),_IQ(-0.8660)}};
//	long Sector4[2][2] = {{_IQ(0),_IQ(-1.7321)},{_IQ(-1.5),_IQ(0.8660)}};
//	long Sector6[2][2] = {{_IQ(-1.5),_IQ(-0.8660)},{_IQ(1.5),_IQ(-0.8660)}};
//	long Sector2[2][2] = {{_IQ(1.5),_IQ(0.8660)},{_IQ(0),_IQ(-1.7321)}};
//*/
////TI
//	float Sector3[2][2] = {{(0.8660),(-0.5)},{(0),(1)}};
//	float Sector1[2][2] = {{(-0.8660),(0.5)},{(0.8660),(0.5)}};
//	float Sector5[2][2] = {{(0),(1)},{(-0.8660),(-0.5)}};
//	float Sector4[2][2] = {{(0),(-1)},{(-0.8660),(0.5)}};
//	float Sector6[2][2] = {{(-0.8660),(-0.5)},{(0.8660),(-0.5)}};
//	float Sector2[2][2] = {{(0.8660),(0.5)},{(0),(-1)}};

//// Vdc feedforward
//#if 0
//	if(v->UdcIn == 0)
//	{
//		v->UdcIn = 1;
//	}

//	v->Ualfa = _IQdiv(v->UalfaIn,v->UdcIn);
//	v->Ubeta = _IQdiv(v->UbetaIn,v->UdcIn);
//#endif

//#if 1
//	v->Ualfa = v->UalfaIn;
//	v->Ubeta = v->UbetaIn;
//#endif

//// Inverse clarke transformation
//    Va = v->Ubeta;
//    Vb = ((-0.5) * v->Ubeta) + ((0.8660254) * v->Ualfa);  // 0.8660254 = sqrt(3)/2
//    Vc = ((-0.5) * v->Ubeta) - ((0.8660254) * v->Ualfa);  // 0.8660254 = sqrt(3)/2

//// 60 degree Sector determination
//    if (Va>(0))
//       Sector = 1;
//    if (Vb>(0))
//       Sector = Sector + 2;
//    if (Vc>(0))
//       Sector = Sector + 4;

//    //v->Sector_Flag = Sector * 2000;


//// X,Y,Z (Va,Vb,Vc) calculations

//    if (Sector==0)  // Sector 0: this is special case for (Ualpha,Ubeta) = (0,0)
//    {
//       v->Ta = 0.5;
//       v->Tb = 0.5;
//       v->Tc = 0.5;
//    }
//    if (Sector==1)  // Sector 1: t1=Z and t2=Y (abc ---> Tb,Ta,Tc)
//    {
//       t1 = (Sector1[0][0] * v->Ualfa) + (Sector1[0][1] * v->Ubeta);
//       t2 = (Sector1[1][0] * v->Ualfa) + (Sector1[1][1] * v->Ubeta);
//       if((t1+t2)>(0.99))
//       {
//           a = t1;
//           b = t2;
//          t1 = (a * 0.99) / (a+b);
//          t2 = (b * 0.99) / (a+b);
//       }
//       v->Tb = 0.5 * (1-t1-t2);      // tbon = (1-t1-t2)/2
//       v->Ta = v->Tb + t1;                             // taon = tbon+t1
//       v->Tc = v->Ta + t2;                             // tcon = taon+t2
//    }
//    else if (Sector==2)  // Sector 2: t1=Y and t2=-X (abc ---> Ta,Tc,Tb)
//    {
//       t1 = (Sector2[0][0] * v->Ualfa) + (Sector2[0][1] * v->Ubeta);
//       t2 = (Sector2[1][0] * v->Ualfa) + (Sector2[1][1] * v->Ubeta);
//       if((t1+t2)>(0.99))
//       {
//           a = t1;
//           b = t2;
//          t1 = (a * 0.99) / (a+b);
//          t2 = (b * 0.99) / (a+b);
//       }
//       v->Ta = (0.5) * (1-t1-t2);      // taon = (1-t1-t2)/2
//       v->Tc = v->Ta+t1;                             // tcon = taon+t1
//       v->Tb = v->Tc+t2;                             // tbon = tcon+t2
//    }
//    else if (Sector==3)  // Sector 3: t1=-Z and t2=X (abc ---> Ta,Tb,Tc)
//    {
//       t1 = (Sector3[0][0] * v->Ualfa) + (Sector3[0][1] * v->Ubeta);
//       t2 = (Sector3[1][0] * v->Ualfa) + (Sector3[1][1] * v->Ubeta);
//       if((t1+t2)>(0.99))
//       {
//           a = t1;
//           b = t2;
//          t1 = (a * 0.99) / (a+b);
//          t2 = (b * 0.99) / (a+b);
//       }
//       v->Ta = (0.5) * (1-t1-t2);      // taon = (1-t1-t2)/2
//       v->Tb = v->Ta+t1;                             // tbon = taon+t1
//       v->Tc = v->Tb+t2;                             // tcon = tbon+t2
//    }
//    else if (Sector==4)  // Sector 4: t1=-X and t2=Z (abc ---> Tc,Tb,Ta)
//    {
//       t1 = (Sector4[0][0] * v->Ualfa) + (Sector4[0][1] * v->Ubeta);
//       t2 = (Sector4[1][0] * v->Ualfa) + (Sector4[1][1] * v->Ubeta);
//       if((t1+t2)>(0.99))
//       {
//           a = t1;
//           b = t2;
//          t1 = (a * 0.99) / (a+b);
//          t2 = (b * 0.99) / (a+b);
//       }
//       v->Tc = (0.5) * (1-t1-t2);      // tcon = (1-t1-t2)/2
//       v->Tb = v->Tc+t1;                             // tbon = tcon+t1
//       v->Ta = v->Tb+t2;                             // taon = tbon+t2
//    }
//    else if (Sector==5)  // Sector 5: t1=X and t2=-Y (abc ---> Tb,Tc,Ta)
//    {
//       t1 = (Sector5[0][0] * v->Ualfa) + (Sector5[0][1] * v->Ubeta);
//       t2 = (Sector5[1][0] * v->Ualfa) + (Sector5[1][1] * v->Ubeta);
//       if((t1+t2)>(0.99))
//       {
//           a = t1;
//           b = t2;
//          t1 = (a * 0.99) / (a+b);
//          t2 = (b * 0.99) / (a+b);
//       }
//       v->Tb = (0.5) * (1-t1-t2);      // tbon = (1-t1-t2)/2
//       v->Tc = v->Tb+t1;                             // tcon = tbon+t1
//       v->Ta = v->Tc+t2;                             // taon = tcon+t2
//    }
//    else if (Sector==6)  // Sector 6: t1=-Y and t2=-Z (abc ---> Tc,Ta,Tb)
//    {
//       t1 = (Sector6[0][0] * v->Ualfa) + (Sector6[0][1] * v->Ubeta);
//       t2 = (Sector6[1][0] * v->Ualfa) + (Sector6[1][1] * v->Ubeta);
//       if((t1+t2)>(0.99))
//       {
//           a = t1;
//           b = t2;
//          t1 = (a * 0.99) / (a+b);
//          t2 = (b * 0.99) / (a+b);
//       }
//       v->Tc = (0.5) * (1-t1-t2);      // tcon = (1-t1-t2)/2
//       v->Ta = v->Tc+t1;                             // taon = tcon+t1
//       v->Tb = v->Ta+t2;                             // tbon = taon+t2
//    }

//}
void Tri_compare(DUTY *duty_cycle,ICLARKE *iclarke)
{
	float highest=3;     //Ëæ±ãÉèµÄÈý½Ç²¨×îÖµ
	if(highest>fabs(iclarke->as)&&highest>fabs(iclarke->bs)&&highest>fabs(iclarke->cs))
	{
		duty_cycle->duty1=(iclarke->as+highest)/(highest-iclarke->as);
		duty_cycle->duty2=(iclarke->bs+highest)/(highest-iclarke->bs);
		duty_cycle->duty3=(iclarke->cs+highest)/(highest-iclarke->cs);
	}
	else
	{
		//error
	}
}	

c


/*	//pid³õÊ¼»¯
	PID_init(&pid1, PID_DELTA, PID1, 4.1, 1, 0.1);
PID_init(&pid2, PID_DELTA, PID2, 100, 100, 0.1);
PID_init(&pid3, PID_DELTA, PID3, 100, 100, 0.1);
*/















